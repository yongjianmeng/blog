# 理解 I/O 中的同步、异步、阻塞、非阻塞 #

## 李华接机的故事 ##
某天，李华邀请远在美国的 Mike 来中国旅游，Mike 要坐飞机过来。出发前 Mike 通知了李华，这时李华可能使用以下五种接机方式：  
1. 李华立马放下手上的事情开车赶往机场去等 Mike。接到 Mike 之后，李华还要再送他到酒店入住。如果碰到飞机晚点，那么李华也只能一直耗在机场。   
2. 李华没有立刻去机场，而是在做别的事情，不过他会时不时地查看一下航班动态。当发现航班到达时，李华放下手上的事情开车赶完机场去接 Mike，并送他到酒店入住。  
3. 李华不仅邀请了 Mike，还邀请了 Jane，而且李华要去不同的机场接他们两个。李华要查看两个航班动态，如果Jane 乘坐的航班先到达，那么他就出发先去接 Jane 并送她到酒店入住，如果 Mike 的航班也达到了，李华还要去接 Mike 并送他到酒店入住。  
4. 李华没有邀请任何人，某天 Mike 突然告诉李华他已经到中国了，李华很惊讶，立马放下手上的事情赶完机场去接 Mike 并送他去酒店入住。  
5. 李华太忙了没办法去接机，他委派自己的秘书去接机，并让秘书送 Mike 到酒店入住，一切办好之后，秘书告诉李华已经把 Mike 安顿好了。

## 五种 I/O 模型的比较 ##
看完李华接机的故事，我们再来看看在[《UNIX 网络编程》](https://book.douban.com/subject/1500149/)中所描述的五种 UNIX I/O 模型的比较：  

![](https://github.com/yongjianmeng/blog/blob/master/images/%E7%90%86%E8%A7%A3IO%E4%B8%AD%E7%9A%84%E5%90%8C%E6%AD%A5%E5%BC%82%E6%AD%A5%E9%98%BB%E5%A1%9E%E9%9D%9E%E9%98%BB%E5%A1%9E-0.png)

如果我们把**李华接机的故事**与 **UNIX I/O 模型**做个模型的映射，可以得到如下映射表  

| 李华接机的故事 | UNIX I/O 模型 |
| -------------| --------------|
| 李华 |  线程 |
| 邀请 |  发起数据请求 |
| Mike |  数据A |
| Jane |  数据B |
| 秘书 |  操作系统支持异步 I/O 的特殊模块 |
| 航班动态 |  数据是否到达内核空间 |
| 机场 | 内核空间 |
| 酒店 | 用户空间 |  

那么五种接机方式与五种 I/O 模型对应关系如下：
  
1. **第一种接机方式对应阻塞 I/O 模型**：当线程发起数据请求后，线程就被阻塞挂起，直到数据到达内核，并从内核空间拷贝到用户空间。
2. **第二种接机方式对应非阻塞 I/O 模型**：当线程发起请求数据后，线程没有被阻塞挂起，可以执行其他任务，但需要它时不时地去检查一下数据是否到达内核空间。如果数据到达了内核空间，那么线程将被阻塞直到数据从内核空间拷贝到用户空间。
3. **第三种接机方式对应 I/O 复用模型**： 单个线程可以同时监视多个数据请求，当某个数据到达内核空间后，线程将被阻塞直到数据从内核空间拷贝到用户空间，之后再去监视其他未完成的数据请求。
4. **第四种接机方式对应信号驱动 I/O 模型**： 数据到达内核空间后才会通知线程，这时线程将被阻塞直到数据从内核空间拷贝到用户空间。
5. **第五种接机方式对应异步 I/O 模型**：线程发起数据请求后就去执行别的任务了。当数据到达内核空间并被拷贝到用户空间后，线程将得到数据已经准备好可以直接使用的通知。

## 如何区分 I/O 中的阻塞与非阻塞 ##
在五种 I/O 模型的比较中，如果在**等待数据**期间，线程是处于阻塞状态，不能做别的事情，那么可以说这是阻塞 I/O。如果线程不处于阻塞状态，可以做别的事，那么就是非阻塞 I/O。

## 如何区分 I/O 中的同步与异步 ##
在五种 I/O 模型中，如果在**将数据从内核拷到用户空间**期间，线程是处于阻塞状态，不能做别的事情，那么可以说这是同步的。如果线程不处于阻塞状态，可以做别的事，那么就是异步的。

## 阻塞/非阻塞、同步/异步之间的关联 ##
从 UNIX I/O 模型角度看：阻塞式 I/O，非阻塞式 I/O，I/O 复用 (select/poll/epoll)、信号驱动 I/O 都属于同步 I/O，因为它们在数据由内核空间拷贝到用户空间时线程都是阻塞的，不能干别的事。只有异步 I/O 模型是符合异步 I/O 操作的含义的，即在数据准备完成时，由内核空间拷贝到用户空间后通知线程，在等待通知的这段时间里线程可以干别的事。下图是对阻塞/非阻塞、同步/异步之间的关联关系做的一个总结，可以看出异步 I/O 需要操作系统层面的特殊模块才能实现：
![](https://github.com/yongjianmeng/blog/blob/master/images/%E7%90%86%E8%A7%A3IO%E4%B8%AD%E7%9A%84%E5%90%8C%E6%AD%A5%E5%BC%82%E6%AD%A5%E9%98%BB%E5%A1%9E%E9%9D%9E%E9%98%BB%E5%A1%9E-1.png)

## 总结 ##
本文只关注 I/O 模型中的阻塞、非阻塞、同步、异步之间的区别与关联，我们也能去其他角度去理解这四个名词的含义，虽然领域不同，但基本的概念还是互通的，有问题欢迎提交 PR 讨论。

